<!DOCTYPE html>
<html>
<head>
    <title>FAQ List</title>
    <script src="vendor/couchapp/loader.js" type="text/javascript"></script>
    <script type="text/javascript">
//when document is ready do stuff
        
        jQuery(document).ready(function($){
            
            //load categories
            $.getJSON('_view/categories/', function(data){
                var array = data.rows;
                $.each(array, function(i, item){
                    $("#category").append('<option value="' + array[i].key + '">'+ array[i].key + '<\/option>');
                });
            });
            
            //load questions
            getContent('','');
            $('#dialog').dialog({ autoOpen: false, closeOnEscape: true, minWidth: 300, resizable: false });
            
            function getContent(category,activatingElement) {
                //total items to gather
                var items;
                
                //get the next set of elements
                var totalRows = 0;
                var offset = 0;
                var getData = new Object();
                //set the number of items
                if (activatingElement) {
                    items = $('#rowCount').val();
                } else {
                    items = $('#rowCount').val();
                };
                getData.limit = items;
                getData.skip = 1;
                //setting the default docs
                var firstDoc, lastDoc;
                //setting the default view
                var view;
                //determine the last element and grab its id
                if ($("#faqTable tr[id]").get(0) != null) {
                    firstDoc = $("#faqTable tr[id]").get(0).id;
                };
                if ($("#faqTable tr[id]").get(-1) != null ) {
                    lastDoc = $("#faqTable tr[id]").get(-1).id;
                };
                
                //grab the current category
                if (category != '') {
                    view = '/faqcouch/_design/' + category.toLowerCase() + '/_view/' + category.toLowerCase();
                } else {
                    //default already set
                    view = '_view/questions_list';
                };
                
                //ordering
                if (activatingElement == 'nextPageLink') {
                    getData.descending = 'false';
                    getData.startkey = '"' + lastDoc + '"';
                    //getData.startkey_docid = lastDoc;
                } else if (activatingElement == 'prevPageLink') {
                    getData.descending = 'true';
                    getData.startkey = '"' + firstDoc + '"';
                    //getData.startkey_docid = firstDoc;
                } else if (activatingElement == 'category') {
                    //loading new dataset
                };

                $.getJSON(view , getData, function(data){
                    //update view with new questions
                    $("#faqTable tr[id]").remove();
                    
                    var array = new Array();
                    array = data.rows;
                    
                    offset = data.offset;
                    totalRows = data.total_rows;
                    
                    var nextPageLinkAccess;
                    var prevPageLinkAccess;
                    
                    if (activatingElement == 'prevPageLink') {   
                        //reverse sort
                        array.reverse();
                    };
                    
                    var i;
                    for (i in array){
                        var css;
                        if (isEven(i)) {
                            css = 'class="even"';   
                        } else {
                            css = 'class="odd"';
                        };
                        $("#faqTable tbody#main").append('<tr id="' + array[i].value._id + '" data-rev="' + array[i].value._rev + '"' + css + '><td>' + array[i].value.question + '<\/td><td>' + array[i].value.answer + '<\/td><td>' + array[i].value.category + '<\/td><td class="actions"><a id="detail' + i.toString() + '" href="">Detail<\/a> <a id="delete' + i.toString() + '" href="">Delete<\/a><\/td><\/tr>');
                    };
                    

                    $("#faqTable tbody > tr > td a[id^='detail']").evently({
                        click: function() {
                            if ($('#dialog').dialog('isOpen')) {
                                $('#dialog').dialog('close');
                                
                            };
                            
                            var message = '<p>you are a chode!' + Math.floor(Math.random()*11).toString() + '</p>';
                            $('#dialog').empty();
                            
                            
                            var rowID = $('#' + this.id).parent().parent().attr('id');
                            
                            $.getJSON('/faqcouch/' + rowID, function(data){
                                console.log(data);
                                if (data._id) {
                                    $('#dialog').append('<p><b>Question: </b>' + data.question + '</p><p><b>Answer: </b>' + data.answer + '</p><p><b>Category: </b>' + data.category + '</p>');
                                };
                                
                            });
                            //set title
                            //set question
                            //set answer
                            //set categories
                            $('#dialog').dialog('open');
                            return false;
                        }
                    });
                    
                    $("#faqTable tbody > tr > td a[id^='delete']").evently({
                        click: function() {
                            var rowID = $('#' + this.id).parent().parent().attr('id');
                            var rowRev = $('#' + this.id).parent().parent().attr('data-rev');
                            removeDocument(rowID, rowRev);
                            //renormalize the colors
                            return false;
                        }
                    });

                    if (activatingElement == 'nextPageLink') {
                        if (totalRows > offset + items) {
                            nextPageLinkAccess = true;
                        } else {
                            nextPageLinkAccess = false;  
                        };
                        if (offset + 1 >= items) {
                            prevPageLinkAccess = true;
                        } else {
                            prevPageLinkAccess = false;  
                        };
                    } else if (activatingElement == 'prevPageLink') {
                        if (offset + 1 <= totalRows) {
                            nextPageLinkAccess = true;
                        } else {
                            nextPageLinkAccess = false;  
                        };
                        
                        if (totalRows >= offset + items + 1) {
                            prevPageLinkAccess = true;
                        } else {
                            prevPageLinkAccess = false;  
                        };
                    } else {
                        if (totalRows > offset + items) {
                            nextPageLinkAccess = true;
                        } else {
                            nextPageLinkAccess = false;  
                        };
                        
                        if (offset >= items) {
                            prevPageLinkAccess = true;
                        } else {
                            prevPageLinkAccess = false;  
                        };
                    };
                    prevNextShading(nextPageLinkAccess,prevPageLinkAccess,false);
                });    
            };
            
            //respond to questions getting clicked
            $("div#nextPrev a").evently({
                click: function() {
                    
                    var elementId = this.id;
                    
                    if ($('#' + elementId).hasClass('gray')) {
                        //ignore if gray
                    } else {
                       //use get content
                        getContent($("#category").val().toLowerCase(),elementId);
                        return false;
                    }
                }
            });
            
                    
        
            //respond to combo box change
            $("#category").evently({
                change: function(){
                    
                    var elementId = this.id;
                    
                    if ($("#category").val() != '') {
                        getContent($("#category").val().toLowerCase(),elementId);
                    } else {
                        getContent('',elementId);
                    };
                   
                }
            });
            
            //respond to combo box change
            $("#rowCount").evently({
                change: function(){
                    
                    var elementId = this.id;
                    
                    if ($("#category").val() != '') {
                        getContent($("#category").val().toLowerCase(),elementId);
                    } else {
                        getContent('',elementId);
                    };
                   
                }
            });
                
            function removeDocument(id,rev){
                jQid = '#'+ id
                jQuery.ajax({
                    type: "DELETE",
                    url: '/faqcouch/' + id + '?rev=' + rev,
                    success: function(){
                            //pop up little window saying its deleted
                            jQuery(jQid).fadeOut('slow');
                    }
                });
                //remove clicked element
                return false;
            };
            
            function isEven(value) {
                if (value%2 == 0) {
                    return true;
                } else {
                    return false;
                };
            };

            
            function prevNextShading(nextPageLinkAccess,prevPageLinkAccess) {
                //determine if shading
                //detering if going forward or backwards
                //if forwards then calculate the offset from 0 to total rows
                //if backwards then calculate the offset from total (top) to 0
                //decide on how to shade next link
                if (nextPageLinkAccess) {
                    $('#nextPageLink').removeAttr('href');
                    $('#nextPageLink').attr('href',' ');
                    if ($('#nextPageLink').hasClass('gray') == true) {
                        $('#nextPageLink').removeClass('gray');
                    };
                } else {
                    if ($('#nextPageLink').attr('href') != true) {
                        $('#nextPageLink').addClass('gray');
                    };
                    if ($('#nextPageLink').attr('href') != true) {
                        $('#nextPageLink').removeAttr('href');
                    };
                };
                
                //decide on how to shade prev link
                if (prevPageLinkAccess) {
                    $('#prevPageLink').removeAttr('href');
                    $('#prevPageLink').attr('href',' ');
                    if ($('#prevPageLink').hasClass('gray') == true) {
                        $('#prevPageLink').removeClass('gray');
                    };
                } else {
                    if ($('#prevPageLink').hasClass('gray') != true) {
                        $('#prevPageLink').addClass('gray');
                    };
                    if ($('#prevPageLink').attr('href') != true) {
                        $('#prevPageLink').removeAttr('href');    
                    };
                };
            };
        });
    </script>
</head>

<body>
    <a href="index.html">Home</a>
    
    <div id="dialog" title="Question Details">
        
    </div>


    <h1 id="title" class="title">FAQ List</h1>
    
    <div class="titleCat">
        <b>Select Single Category: </b><select id="category" name="category">
            <option value="">
                Show All
            </option>
        </select>
    </div>
    
    <table id="faqTable">
        <thead>
            <tr>
                <th>Question</th>
                <th>Answer</th>
                <th>Category</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="main">
        </tbody>
        <tbody class="footer">
            <tr>
                <td colspan="4">
                    <div id="nextPrev"><a id="prevPageLink" href="" name="prevPageLink">&lt;- Prev</a> <select id="rowCount"><option>5</option><option>10</option><option>20</option></select> <a id="nextPageLink" href="" name="nextPageLink">Next -&gt;</a></div>
                </td>
            </tr>
        </tbody>
    </table>

   

</body>
</html>